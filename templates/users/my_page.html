{% extends 'base.html' %}
{% load static %}

{% block script %}
<link rel="stylesheet" href="{% static 'css/my_page.css' %}">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css" integrity="sha384-DyZ88mC6Up2uqS4h/KRgHuoeGwBcD4Ng9SiP4dIRy0EXTlnuz47vAwmeGwVChigm" crossorigin="anonymous">
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap-theme.min.css"> -->
<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script> -->
<!-- <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script> -->


<script>
    const modal = document.querySelector('.point_modal');
    const modalBody = document.querySelector('.modal_body');
    const pointOpenPopup = document.querySelector('.point_gage');
    const body = document.querySelector('body');

    pointOpenPopup.addEventListener('click', () => {
        modal.style.display = 'block';
        body.style.overflow = 'hidden';
        modalBody.style.display = 'block';
        modalBody.style.transform = 'translateY(-110%)'
    });

    modalBody.addEventListener('click', () => {
        modal.style.display = 'none';
        body.style.overflow = 'auto';
    })
</script>
<!-- 팔로우 모달 창 뜨기 -->
<script>
    const followModal = document.querySelector('.follow_modal');
    const followBody = document.querySelector('.follow_body');
    const followOpenPopup = document.querySelector('.follow_btn');

    followOpenPopup.addEventListener('click', () => {
        followModal.style.display = 'block';
        body.style.overflow = 'hidden';
        followBody.style.display = 'block';
    });

    followBody.addEventListener('click', () => {
        followModal.style.display = 'none';
        body.style.overflow = auto
    })
</script>

<!-- ------------------------------------------------------------------------ -->
<script>
    const logFolderBtn = document.getElementById('log_folder_btn');
    const categoryTab = document.querySelector('.folder_category');
    console.log(logFolderBtn)
    logFolderBtn.addEventListener('click', () => {
        //url를 user.pk로 설정해줘야 한다.
        id =logFolderBtn.value;
        
        var a = "http://127.0.0.1:8000/users/" + id
        var url = a + "/digging_folder/"
        
        fetch(url, {
            method: "GET",
            headers : { 
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            },
        })
        .then(res => res.json())
        .then(data => {
            console.log(data)
            if (data.length === 0) {
                categoryTab.innerHTML = "폴더없음"
            } else {
                const txt = data.map(folder => {
                    return `
                        ${folder.folder_name}
                    `
                })
                categoryTab.innerHTML = txt;
            }
        })
    })
</script>
<!-- ------------------------------------------------------------------------ -->



<!-- 최근 (기록/질문) 뜨게하기 -->
<!-- 구현하려다가 어려워서 넘김.. 기존데이터를 가져와서 출력해주는거 알아보기....ajax어렵당.. -->
{%comment%}
<script>
    const requestLastList = new XMLHttpRequest();
    
    const onClickLastList = (type) => { //함수정의 : 어떤 버튼을 눌렀는지 받아온다. (삽질모음이냐 질문모음이냐)
        const url = '/posts/last_log_questions/'; //어느 url로 요청할 것인지.
        requestLastList.open('POST', url, true); //post방식으로 이 url에 ajax방식으로 요청을보내는데, 
        requestLastList.setRequestHeader( // requestheader로 이 요청을 보낸다. 자세한건 나중에
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestLastList.send(JSON.stringify({type: type})); //요청할 때 필요한 정보들. ajax방식으로 할 땐 무.조.건 JSON방식으로 보내야함.
    };
    
    const lastListHandleResponse = () => {  //응답 처리해주는 함수 (최근 남긴 삽질 기록 / 질문 )보여주는 함수
        if (requestLastList.status < 400) {
            const {type} = JSON.parse(requestLastList.response);    // {'type': 'dig'} or {'type': 'question'}
            const addLastList = document.querySelector(`.post__${type}`);

            addLastList.innerHTML = `
            `;
        }
    };
</script>
{%endcomment%}


{% endblock script %}

{% block content %}
<div class="container_box">
    <!-- 포인트 기록 모달창 -->
    <div class="point_modal">
        <div class="modal_body">
            <h2>내 포인트 기록</h2>
            {% for sand in my_all_sands %}
                <div class="log_box">
                    <p>{{sand.user}}</p>
                    <p>{{sand.amout}}</p>
                    <p>{{sand.reason}}</p>
                </div>
            {% endfor%}
        </div>
    </div>
    <!-- 포인트 모달창 끝 -->
    <!-- 팔로우모달창 -->
    <div class="follow_modal">
        <div class="follow_container follow_body">
            <div class="follower">
                <div class="follow_count">
                    <h3>{{request.user.username}}님을 팔로우하는 사람 </h3>
                    <h3>{{ host_follower|length }}명</h3>
                </div>
                {% for follower in host_follower %}
                <div class="follow_list">
                    {% if follower.user_profile_image %}
                        <img class="follow_image" src="{{ follower.user_profile_image.url }}" width="200">
                    {% else %}
                        <div class="follow_image" ></div>
                    {% endif %}
                    <div class="flex_col">
                        <h3>{{follower.user_level}}</h3>
                        <h3>{{ follower.username }}</h3>
                    </div>
                    <div class="follow_desc">
                        <h3>{{ follower.email }}</h3>
                    </div>
                </div>
                {% endfor %}
            </div>
            <div class="following">
                <div class="follow_count">
                    <h3>{{request.user.username}}님이 팔로우하는 사람 </h3>
                    <h3>{{ host_following|length }}명</h3>
                </div>
                {% for following in host_following %}
                <div class="follow_list">
                    {% if follower.user_profile_image %}
                        <img class="follow_image" src="{{ following.user_profile_image.url }}" width="200">
                    {% else %}
                        <div class="follow_image" ></div>
                    {% endif %}
                    <div class="flex_col">
                        <h3>{{following.user_level}}</h3>
                        <h3>{{ following.username }}</h3>
                    </div>
                    <div class="follow_desc">
                        <h3>{{ following.email }}</h3>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- 내 마이페이지 -->
    <div class="first_container my_container">
        <div class="profile_container">
            {% if request.user.pk == host.pk %}
                <div class="profile_area">
                    <div class="profile_username">
                        {% if host.user_profile_image %}
                            <span class="profile_image">
                                <img src="{{ host.user_profile_image.url}}">
                            </span>
                        {% else %}
                            <i class="fas fa-user-circle fa-3x"></i>
                        {% endif %}
                        <span class="user_nickname">{{ request.user.username }}님의 모래상자<span>
                    </div>
                    <div class="sand_level_area">
                        <div class="level_badge">
                            <a href="#" class="badge_img">
                                {% if host.user_level == 0 %}
                                <img src="{% static 'image/sandbox.png' %}" style="height: 24px;" >
                                <span>Lv. {{host.user_level}} 맨바닥</span>
                                {% elif host.user_level == 1 %}
                                <img src="{% static 'image/sand-castle.png' %}" style="height: 24px;">
                                <span>Lv. {{host.user_level}} 모래성</span>
                                {% elif host.user_level == 2 %}
                                <img src="{% static 'image/home.png' %}" style="height: 24px;">
                                <span>Lv. {{host.user_level}} 벽돌집</span>
                                {% else %}
                                <img src="{% static 'image/building.png' %}" style="height: 24px;">
                                <span>Lv. {{host.user_level}} 아파트</span>
                                {% endif %}
                                <!-- 레벨 기준 알려주는 모달창 -->
                                <div class="level_modal">
                                    <div class="desc_box">
                                        <div class="level_list">
                                            <img src="{% static 'image/sandbox.png' %}" style="height: 16px;">
                                            <span>Lv.맨바닥</span>
                                            <p>모래 포인트 2000미만</p>
                                        </div>
                                        <div class="level_list">
                                            <img src="{% static 'image/sand-castle.png' %}" style="height: 16px;">
                                            <span>Lv.모래성</span>
                                            <p>모래 포인트 2000이상 7000미만</p>
                                        </div>
                                        <div class="level_list">
                                            <img src="{% static 'image/home.png' %}" style="height: 16px;">
                                            <span>Lv.벽돌집</span>
                                            <p>모래 포인트 7000이상 18000미만</p>
                                        </div>
                                        <div class="level_list">
                                            <img src="{% static 'image/building.png' %}" style="height: 16px;">
                                            <span>Lv.아파트</span>
                                            <p>모래 포인트 18000이상</p>
                                        </div>
                                    </div>
                                </div>
                                <!-- 레벨 기준 모달창 끝 -->
                            </a>
                        </div>
                    </div>
                    <div class="point_gage">
                        <label for="value_low">{{my_sand_sum.amount__sum}} 모래포인트</label>
                        {% if host.user_level == 0 %}
                        <meter id="value_low" min="0" max="2000" low="500" high="1000" optimum="1500" value="{{my_sand_sum.amount__sum}}"></meter>
                        {% elif host.user_level == 1 %}
                        <meter id="value_low" min="2000" max="7000" low="4000" high="4000" optimum="5500" value="{{my_sand_sum.amount__sum}}"></meter>
                        {% else%}
                        <meter id="value_low" min="7000" max="18000" low="10000" high="13000" optimum="16000" value="{{my_sand_sum.amount__sum}}"></meter>
                        {% endif %}
                    </div>
                    <div class="proflie_text">    
                    {% if request.user.user_profile_content %}    
                        {{request.user.user_profile_content}}
                    {% else %}
                        <p>
                            아직 자기소개가 없습니다.
                        </p>
                    {% endif %}
                    </div>
                    <div class="follow_area">
                        <div class="follow_btn_area">
                            <button class="follow_btn">팔로잉 {{request.user.user_following|length}}</button>
                            <button class="follow_btn">팔로워 {{request.user.user_followed|length}}</button>
                        </div>
                    </div>
                </div>
            {% else %}    
                <!-- 다른유저 마이페이지 -->
                <div class="profile_area">
                    <h1> {{ host.user_nickname}}님의 모래상자 </h1>
                </div>
                <a href = '{% url "users:follow" host.id %}'><button class="follow_btn">팔로우하기</button></a>
                <div>
                    <label for="value_low">{{user.user_point}} 모래포인트</label>
                    <!-- value값이 내 모래포인트에 따라서 반영되어야함. max기준도 레벨에 따라 바뀌어야함.(아직구현X) -->
                    <meter id="value_low" min="0" max="100" low="30" high="60" optimum="90" value="10"></meter>
                    {% if host.user_level == 0 %}
                    <meter id="value_low" min="0" max="2000" low="500" high="1000" optimum="1500" value="{{my_sand_sum.amount__sum}}"></meter>
                    {% elif host.user_level == 1 %}
                    <meter id="value_low" min="2000" max="7000" low="4000" high="4000" optimum="5500" value="{{my_sand_sum.amount__sum}}"></meter>
                    {% else %}
                    <meter id="value_low" min="7000" max="18000" low="10000" high="13000" optimum="16000" value="{{my_sand_sum.amount__sum}}"></meter>
                    {% endif %}
                </div>
                <div class="proflie_text">    
                {% if request.user.user_profile_content %}    
                    {{request.user.user_profile_content}}
                {% else %}
                    <p>
                        아직 자기소개가 없습니다.
                    </p>
                {% endif %}
                </div>
                <div class="follow_area">
                    <a href=""><button class="follow_btn">팔로잉 {{ host_following|length }}</button></a>
                    <a href=""><button class="follow_btn">팔로워 {{ host_follower|length }}</button></a>
                </div>
            {% endif %}
        </div>
        <hr>
        <div class="btn_list_area">
            <button href="" class="list_btn" id="log_folder_btn" value="{{host.id}}">삽질 기록 모음 > </button>
            <button class="list_btn" id="question_folder_btn">질문 모음 > </button>
            <button class="list_btn">내가 남긴 답변 목록 > </button>
            {% if request.user.pk == host.pk %}
            <a href = '{% url "users:account_detail" host.id %}'><button class="list_btn">계정 관리 > </button></a>
            {% else %}
            {% endif %}
        </div>
        <div class="sand_pour_area"></div>
    </div>
    <div class="second_container my_container">
        <div class="category_tab">
            <button>언어</button>
            <button>해결/미해결</button>
            <button>프레임워크</button>
            <div class="folder_category">

            </div>
        </div>


        <div class="folder_area">
            <div id="myCarousel" class="carousel slide" data-ride="carousel">
                <!-- Wrapper for slides -->
                {% for folder in framework_folders %}
                    <div class="folder_space">
                        <button type="button" class="{{folder}}">
                            <i class="far fa-folder folder_icon fa-2x"></i>  
                            <span class="folder_name">{{folder}}</span>\
                        </button>
                    </div>
                {% endfor %}
            </div>
        </div>


    </div>
    <!-- 질문버튼 눌렀을 때도 그에 해당하는 디렉토리들이 다르게 떠야함 -->
        {%comment%}
    <div class="last_log_box post__dig">
        {% for log in my_recent_logs %}
            <div class="last_log_list">
                {{log.title}}
            </div>
        {% endfor %}
    </div>
    <div class="last_question_box post__question">
        <!-- 질문버튼 누르면 최근 질문 기록도 같이 뜸 -->
        {% for question in my_recent_questions %}
            <div class="last_question_list">
                {{question.title}}
            </div>
        {% endfor %}
    </div>
    </div>
    {%endcomment%}
    <!-- 폴더 눌렀을 때 글 목록 뜨는 곳 -->
    <div class="third_container my_container">
        <div class="my_post_list">
        </div>
    </div>
{% endblock %}
