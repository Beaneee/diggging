{% extends 'questions/base.html' %}
{% load static %}
{% block script %}
<link rel="stylesheet" href="{% static 'css/questions/main.css' %}">
<link rel="stylesheet" href="https://pro.fontawesome.com/releases/v5.10.0/css/all.css" integrity="sha384-AYmEC3Yw5cVb3ZcuHtOA93w35dYTsvhLPVnYs9eStHfGJvOvKxVfELGroGkvsg+p" crossorigin="anonymous"/>
<script>
    const requestAnswer = new XMLHttpRequest();
    const onClickAnswer = (id) =>{
        const url = '/questions/answer_ajax/';
        requestAnswer.open('POST',url,true);
        requestAnswer.setRequestHeader(
            'Content-Type',
            'application/x-www-form-urlencoded'
        );
        requestAnswer.send(JSON.stringify({id:id}));
    };
    const AnswerHandleResponse = () =>{
        if(requestAnswer.status < 400){
            const answer = requestAnswer.response;
            const obj = JSON.parse(answer);
            const userObj = JSON.parse(obj.user); // 유저 데이터
            
            console.log(userObj);
            console.log(obj)

             //답변 데이터 -> 질문을 올린사람의 id가 필요
            for (let i=0; i < obj.answer.length; i++) {
                for (let j=0; j < userObj.length; j++){
                    if(obj.answer[i].question_id === userObj[j].pk)
                    obj.answer[i]['username'] = userObj[j].fields.username;
                    obj.answer[i]['result'] = []
                }
            }
            // console.log(answer[0][0].answers.user.user_nickname)
            const answerab = document.querySelector('.answerabc');
            

            // title, desc, username
            const title = [];
            const desc = [];
            const username = [];
            for (let i=0; i < obj.answer.length; i++){
                title.push(obj.answer[i].title)
                desc.push(obj.answer[i].desc)
                username.push(obj.answer[i].username)
            }
            
            // result = [title, desc, username]
            for (let i=0; i < obj.answer.length; i++) {
                obj.answer[i]['result'].push(title[i])
                obj.answer[i]['result'].push(desc[i])
                obj.answer[i]['result'].push(username[i])
            }

            const result = []

            for (let i=0; i < obj.answer.length; i++) {
                result[i] = (obj.answer[i].result)
            }

            console.log(result[0])
            console.log(result[1])

            answerab.innerHTML =`
            <div class="last_answer_box">
                <div class="answer_id_0">
                    ${result[0]}
                </div>
                <div class="answer_id_1">
                    ${result[1]}
                </div>
                <div class="answer_id_2">
                    ${result[2]}
                </div>
                <div class="answer_id_3">
                    ${result[3]}
                </div>
                <div class="answer_id_4">
                    ${result[4]}
                </div>
            </div>
            `
        }
    };

    requestAnswer.onreadystatechange = () =>{
        if(requestAnswer.readyState === XMLHttpRequest.DONE){
            AnswerHandleResponse();
        };
    };

</script>
{% endblock %}
{% block content %}
<!-- 네비바 아래로 가게하는 컨테이너 -->
<div class="container">
    <div class="box_container">
        <!-- 왼쪽 박스들 -->
        <div class="left_container">
            <!-- 답변을 기다리는 질문 박스 -->
            <div class="no_answer_container">
                <div>
                    <h3>답변을 기다리는 질문들</h3>
                </div>
                <div class="no_answer_list_box">
                    {% for post in selected_answer_posts %}
                    <div class="no_answer_list">
                        <a href="{% url 'question:question_post_detail' post.user.id post.id %}">
                            <div class="no_user_info">
                                {% if post.user.user_profile_image %}
                                    {{ post.user.user_profile_image.url }}
                                {% else %}
                                    <i class="fas fa-user-circle fa-2x" style="color:bisque"></i>
                                {% endif %}
                                    <span class="no_answer_username">{{post.user.user_nickname}}</span>
                            </div>
                            <span class="no_answer_title">{{post.title|truncatechars:20}}</span>
                            <span class="no_answer_username">{{post.desc|safe|escape|truncatechars:80|striptags|cut:"&nbsp;" }}</span>
                        </a>
                        <!--채택이 false인거만 나오게 한다.-->
                    </div>
                    {% endfor %}
                </div>
            </div>
            <!-- 답변 기다리는 질문박스 끝 -->
            <!-- 관심사에 따른 추천 박스 -->
            <div class="recommend_container">
                <div>
                    <h3>내가 관심있는 </h3>
                </div>
                <div class="recommned_list_box">
                    <!-- 관심사목록선택 체크박스 -->
                    <form action="" method="POST">
                        {%csrf_token%}
                        <button type="submit">제출</button>
                        <div class="checkbox">
                            {% for languages in language %}
                            <div class="input_wrap">
                                <input type="checkbox" name="answers[]" id="answer1"
                                    value={{languages}}>{{languages}}</input>
                            </div>
                            {%endfor%}
                        </div>
                    </form>
                    <!-- 체크박스끝 -->
                    <!-- 관심사에 따른 질문 목록들 -->
                    <div class="recommend_list_box">
                        {% for post in posts%}
                        {%if str_search == post.language %}
                        <div class="recommend_list">
                            <a href="{% url 'question:question_post_detail' post.user.id post.id %}">
                                <div class="recommend_user_info">
                                    {% if post.user.user_profile_image %}
                                        {{ post.user.user_profile_image.url }}
                                    {% else %}
                                        <i class="fas fa-user-circle fa-2x" style="color:bisque"></i>
                                    {% endif %}
                                        <span class="post_username">{{post.user.user_nickname}}</span>
                                </div>
                                <div class="post_title">{{post.title|truncatechars:20}}</div>
                                <div class="post_desc">{{post.desc|safe|escape|truncatechars:80|striptags|cut:"&nbsp;" }}</div>
                            </a>
                        </div>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <!-- 관심사 질문목록 끝 -->
                </div>
            </div>
        </div>
        <!-- 왼쪽 영역 끝 -->
        <div class="right_container">
            <div class="profile_area">
                <div class="profile_container">
                    <!-- 로그인 되었을 때 -->
                    {% if user.is_authenticated %}
                    <div>
                        <div class="profile_username">
                            {% if host.user_profile_image %}
                            <span class="profile_image">
                                <img src="{{ request.user.user_profile_image.url}}">
                            </span>
                            {% else %}
                            <i class="fas fa-user-circle fa-2x" style="color:bisque"></i>
                            {% endif %}
                            <p class="user_nickname">{{ request.user.user_nickname }}님의 모래상자<p>
                        </div>
                        <p>
                        레벨 | {{user.user_level}} 단계
                        </p>
                        <div class="point_gage">
                            <label for="value_low">{{user.point_sum}} 모래포인트</label>
                            <!-- max기준 레벨에 따라 if문으로 바뀌어야함(아직level넘겨주지 않아서 구현 X)  -->
                            {% if host.user_level == 0 %}
                            <meter id="value_low" min="0" max="2000" low="500" high="1000" optimum="1500" value="{{my_sand_sum.amount__sum}}"></meter>
                            {% elif host.user_level == 1 %}
                            <meter id="value_low" min="2000" max="7000" low="4000" high="4000" optimum="5500" value="{{my_sand_sum.amount__sum}}"></meter>
                            {% else%}
                            <meter id="value_low" min="7000" max="18000" low="10000" high="13000" optimum="16000" value="{{my_sand_sum.amount__sum}}"></meter>
                            {% endif %}
                        </div>
                        <div class="proflie_text">
                            {% if request.user.user_profile_content %}
                            {{request.user.user_profile_content|truncatechars:40}}
                            {% else %}
                            <p>
                                아직 자기소개가 없습니다.
                            </p>
                            {% endif %}
                        </div>
                    </div>
                {% else %}
                    <!-- 로그인 안했을 때 -->
                    <div class="profile">
                        <div class="profile_username">
                            <i class="fas fa-user-circle fa-2x" style="color:bisque"></i>
                            <a href="{% url 'users:login' %}" class="user_nickname">로그인<a>
                        </div>
                        <div class="proflie_text">
                            <p>
                                로그인 하고 질문을 남겨보세요.
                            </p>
                        </div>
                    </div>
                {% endif %}
                </div>
            </div>
            <!-- 디렉토리영역 -->
            <!-- 탭 버튼 누르면 그에 해당하는 폴더 목록이 뜬다. -->
            <div class="category_tab">
                <button>언어</button>
                <button>프레임워크</button>
            </div>
            <div class="folder_area">
            {{request.user.folder_user.folder_name}}
            </div>
            <!-- 오른쪽 아래 내가 남긴 답변 영역 -->
            <div class="my_answer_container">
                <div>
                    <button class="btn_my_answer" onclick="onClickAnswer({{request.user.id}})">내가 남긴 답변</button>
                </div>
                <div class="answerabc">
                </div>
            </div>
            <!-- 내가 남긴 답변 영역 끝 -->
        </div>
    </div>
{% endblock %}